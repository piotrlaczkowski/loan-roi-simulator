<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advanced Bank Credit & Rental ROI Simulator</title>
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: linear-gradient(to top right, #f9fafb, #eef2f7);
      margin-top: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      max-width: 1400px;
    }

    .card {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .card-title {
      margin-bottom: 1rem;
      color: #007bff;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-header {
      color: #2d3748;
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-header i {
      color: #3182ce;
    }

    /* Chart containers */
    #chartContainer, #roiChartContainer {
      position: relative;
      height: 320px;
      width: 100%;
    }

    .badge-ratio {
      background-color: #dbeafe;
      color: #1e40af;
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
    }

    .alert-warning {
      margin-bottom: 1rem;
    }

    .recommendations {
      margin-top: 1rem;
      list-style: none;
      padding-left: 1rem;
    }
    .recommendations li::before {
      content: "• ";
      color: #007bff;
      font-weight: bold;
    }
  </style>
</head>
<body>
<div class="container mb-4">
  <h1 class="text-center my-4" style="color: #2d3748;">
    <i class="bi bi-bank"></i> Advanced Bank Credit &amp; Rental ROI Simulator
  </h1>

  <div class="row">
    <!-- Left Column: Inputs -->
    <div class="col-md-4">
      <!-- Loan & Income Parameters -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-cash-stack"></i> Loan & Income Parameters</h5>

          <!-- Loan Amount -->
          <div class="mb-3">
            <label for="loanAmount" class="form-label">Loan Amount (€)</label>
            <input type="number" class="form-control" id="loanAmount" value="200000"/>
          </div>

          <!-- Monthly Income -->
          <div class="mb-3">
            <label for="monthlyIncome" class="form-label">Monthly Income (Net) (€)</label>
            <input type="number" class="form-control" id="monthlyIncome" value="4000"/>
          </div>

          <!-- Credit Duration -->
          <div class="mb-3">
            <label for="creditYears" class="form-label">Credit Duration (Years)</label>
            <select class="form-select" id="creditYears">
              <option value="10">10 Years</option>
              <option value="15" selected>15 Years</option>
              <option value="20">20 Years</option>
            </select>
          </div>

          <!-- Interest Rate -->
          <div class="mb-3">
            <label for="interestRate" class="form-label">Interest Rate (%)</label>
            <input
              type="range"
              class="form-range"
              min="1"
              max="10"
              step="0.1"
              id="interestRate"
              value="3.7"
              oninput="document.getElementById('interestRateLabel').innerText = interestRate.value"
            />
            <div>
              Current: <span id="interestRateLabel">3.7</span>%
            </div>
          </div>

          <!-- Apartment Price (For Max Loan Calculation) -->
          <div class="mb-3">
            <label for="housingValue" class="form-label">Apartment Price (€)</label>
            <input type="number" class="form-control" id="housingValue" value="250000"/>
          </div>

          <!-- Additional costs: property tax, insurance -->
          <div class="mb-3">
            <label for="propertyTax" class="form-label">Property Tax / Insurance (monthly, €)</label>
            <input type="number" class="form-control" id="propertyTax" value="100"/>
          </div>

          <button class="btn btn-primary w-100 mb-3" onclick="updateSimulation()">Simulate Credit</button>

          <!-- Max Loan Based on 37% Ratio -->
          <p class="small text-muted mb-0">
            <i class="bi bi-calculator"></i> Based on 37% ratio, max loan you can afford: 
            <strong id="maxLoanPossible">€0</strong>.
          </p>
        </div>
      </div>

      <!-- Rental Simulation -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-house-fill"></i> Rental ROI Parameters</h5>
          <div class="mb-3">
            <label for="monthlyRent" class="form-label">Monthly Rent (€)</label>
            <input type="number" class="form-control" id="monthlyRent" value="800"/>
          </div>

          <div class="mb-3">
            <label for="monthlyExpenses" class="form-label">Maint. & Utilities (monthly, €)</label>
            <input type="number" class="form-control" id="monthlyExpenses" value="150"/>
          </div>

          <div class="mb-3">
            <label for="occupancyRate" class="form-label">Occupancy Rate (%)</label>
            <input
              type="range"
              class="form-range"
              min="0"
              max="100"
              step="1"
              id="occupancyRate"
              value="90"
              oninput="document.getElementById('occupancyRateLabel').innerText = occupancyRate.value"
            />
            <div>Current: <span id="occupancyRateLabel">90</span>%</div>
          </div>
          <button class="btn btn-secondary w-100" onclick="updateSimulation()">Simulate Rent ROI</button>
        </div>
      </div>
    </div>

    <!-- Right Column: Results -->
    <div class="col-md-8">
      <!-- Debt Ratio Alert -->
      <div id="debtRatioAlert" class="alert alert-warning d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        Your monthly payment exceeds the 37% debt-to-income ratio.
      </div>

      <!-- Key Results -->
      <div class="card">
        <div class="card-body">
          <div class="section-header">
            <i class="bi bi-speedometer2"></i>
            <span>Key Results</span>
          </div>
          <p><strong>Monthly Payment:</strong> <span id="monthlyPayment">€0</span></p>
          <p><strong>Total Amount Paid (Principal + Interest):</strong> <span id="totalPaid">€0</span></p>
          <p><strong>Total Interest Paid:</strong> <span id="totalInterest">€0</span></p>
          <p>
            <strong>Debt Ratio:</strong> 
            <span id="debtRatio" class="badge-ratio">0</span>% (Max allowed: 37%)
          </p>
          <p>
            <strong>Estimated Property Value after 
              <span id="creditYearsLabel">15</span> years:</strong>
            <span id="finalHousingValue">€0</span>
          </p>
          <p>
            <strong>Inflation Factor in 
              <span id="inflationYearsLabel">15</span> yrs:</strong>
            <span id="inflationFactorLabel">1.00</span>x
          </p>
        </div>
      </div>

      <!-- Chart: Payment & Interest Timeline -->
      <div class="card">
        <div class="card-body">
          <div class="section-header">
            <i class="bi bi-bar-chart-line-fill"></i>
            <span>Payment & Interest Timeline</span>
          </div>
          <div id="chartContainer">
            <canvas id="balanceChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Second Chart: Break-Even & ROI Analysis -->
      <div class="card">
        <div class="card-body">
          <div class="section-header">
            <i class="bi bi-piggy-bank-fill"></i>
            <span>Break-Even & ROI Analysis</span>
          </div>
          <div id="roiChartContainer">
            <canvas id="roiChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Rental ROI Results -->
      <div class="card">
        <div class="card-body">
          <div class="section-header">
            <i class="bi bi-house-door-fill"></i>
            <span>Rental ROI Details</span>
          </div>
          <p><strong>Monthly Rent (Occupancy-Adjusted):</strong> €<span id="adjustedRent">0</span></p>
          <p><strong>Monthly Net Cashflow from Rent:</strong> €<span id="rentCashflow">0</span> 
            (<span id="rentROI">0</span>% ROI vs mortgage)
          </p>
          <p><strong>Years to break-even on interest (approx.):</strong> <span id="breakEvenRental">-</span> years</p>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="card">
        <div class="card-body">
          <div class="section-header">
            <i class="bi bi-lightbulb-fill"></i>
            <span>Strategy Recommendations</span>
          </div>
          <ul class="recommendations" id="recommendations"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons (for the i.bi icons) -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
/>

<script>
  let balanceChart;  // global Chart.js instance for Payment & Interest
  let roiChart;      // global Chart.js instance for Break-Even & ROI
  const DEBT_RATIO_MAX = 0.37; // 37% debt ratio

  function computeCreditSimulation(principal, annualInterestRate, creditYears) {
    /**
     * Amortization formula (monthly):
     * Payment = P * [r / (1 - (1 + r)^(-n))]
     * Where:
     *  P = principal
     *  r = monthly interest rate (annual interest / 12)
     *  n = total number of months
     */
    const monthlyRate = annualInterestRate / 100 / 12;
    const numberOfMonths = creditYears * 12;

    let monthlyPayment;
    if (monthlyRate === 0) {
      monthlyPayment = principal / numberOfMonths;
    } else {
      monthlyPayment = principal * (monthlyRate / (1 - Math.pow(1 + monthlyRate, -numberOfMonths)));
    }

    let remainingBalance = principal;
    let totalInterest = 0;
    const timelineData = [];

    for (let month = 1; month <= numberOfMonths; month++) {
      const interestThisMonth = remainingBalance * monthlyRate;
      const principalPaid = monthlyPayment - interestThisMonth;
      totalInterest += interestThisMonth;
      remainingBalance -= principalPaid;

      if (remainingBalance < 0) remainingBalance = 0;
      timelineData.push({
        month,
        remainingBalance,
        paidInterest: interestThisMonth,
      });

      if (remainingBalance <= 0) break;
    }

    const totalPaid = monthlyPayment * numberOfMonths;
    return {
      monthlyPayment,
      totalPaid,
      totalInterest,
      timelineData,
    };
  }

  function estimateHousingValue(currentValue, annualIncrease, years) {
    return currentValue * Math.pow(1 + annualIncrease / 100, years);
  }

  function computeInflationFactor(annualInflation, years) {
    return Math.pow(1 + annualInflation / 100, years);
  }

  function initCharts() {
    const ctx1 = document.getElementById('balanceChart').getContext('2d');
    balanceChart = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Remaining Balance',
            data: [],
            borderColor: 'rgb(75,192,192)',
            backgroundColor: 'rgba(75,192,192,0.2)',
            yAxisID: 'y',
            tension: 0.3,
            fill: true,
          },
          {
            label: 'Monthly Interest Paid',
            data: [],
            borderColor: 'rgb(255,99,132)',
            backgroundColor: 'rgba(255,99,132,0.2)',
            yAxisID: 'y1',
            tension: 0.3,
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: {
              display: true,
              text: 'Balance (€)',
            },
          },
          y1: {
            type: 'linear',
            position: 'right',
            title: {
              display: true,
              text: 'Interest (€)',
            },
            grid: {
              drawOnChartArea: false,
            },
          },
        },
      },
    });

    const ctx2 = document.getElementById('roiChart').getContext('2d');
    roiChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Cumulative Interest',
            data: [],
            borderColor: 'rgb(255,159,64)',
            backgroundColor: 'rgba(255,159,64,0.2)',
            fill: true,
            tension: 0.3,
          },
          {
            label: 'Cumulative Rental Profit',
            data: [],
            borderColor: 'rgb(54,162,235)',
            backgroundColor: 'rgba(54,162,235,0.2)',
            fill: true,
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Cumulative Amount (€)',
            },
          },
        },
      },
    });
  }

  function calculateMaxLoan(monthlyIncome, interestRate, creditYears) {
    /**
     * We want monthlyPayment / monthlyIncome <= 0.37
     * monthlyPayment = principal * (r / (1 - (1 + r)^(-n)))
     * Solve for principal given monthlyPayment = monthlyIncome * 0.37
     */
    const monthlyRate = interestRate / 100 / 12;
    const numberOfMonths = creditYears * 12;
    const maxPayment = monthlyIncome * DEBT_RATIO_MAX;

    if (monthlyRate === 0) {
      // trivial case
      return maxPayment * numberOfMonths;
    }

    // Rearranged formula: 
    // principal = monthlyPayment * (1 - (1+r)^(-n)) / r
    const principal = maxPayment * (1 - Math.pow(1 + monthlyRate, -numberOfMonths)) / monthlyRate;
    return principal;
  }

  function updateSimulation() {
    // Collect inputs
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
    const housingValue = parseFloat(document.getElementById('housingValue').value) || 0;
    const creditYears = parseInt(document.getElementById('creditYears').value, 10);

    const interestRate = parseFloat(document.getElementById('interestRate').value) || 3.7;
    const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;

    const inflationRate = 2.0; // default, or read from an input
    const housingIncrease = 2.0; // default, or read from an input

    // For advanced usage, we can also attach sliders for inflation/housingIncrease again, but let's assume them:
    // (We can uncomment if we want the user controls for those again)
    // const inflationRate = parseFloat(document.getElementById('inflationRate').value) || 2.0;
    // const housingIncrease = parseFloat(document.getElementById('housingIncrease').value) || 2.0;

    const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
    const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
    const occupancyRate = parseFloat(document.getElementById('occupancyRate').value) || 0;

    // Update labels
    document.getElementById('creditYearsLabel').textContent = creditYears;
    document.getElementById('inflationYearsLabel').textContent = creditYears;

    // 1) Compute loan details
    const simulation = computeCreditSimulation(loanAmount, interestRate, creditYears);

    // 2) Update Key Results
    const monthlyPayment = simulation.monthlyPayment + propertyTax; 
    // propertyTax acts like an additional monthly cost for the property
    const totalInterest = simulation.totalInterest;
    const totalPaid = simulation.totalPaid + (propertyTax * (creditYears * 12));

    document.getElementById('monthlyPayment').textContent = '€' + monthlyPayment.toFixed(2);
    document.getElementById('totalPaid').textContent = '€' + totalPaid.toFixed(2);
    document.getElementById('totalInterest').textContent = '€' + totalInterest.toFixed(2);

    // Debt ratio
    const monthlyPaymentRatio = (monthlyPayment / monthlyIncome) || 0;
    document.getElementById('debtRatio').textContent = (monthlyPaymentRatio * 100).toFixed(2);

    // Debt ratio alert
    const debtRatioAlert = document.getElementById('debtRatioAlert');
    if (monthlyPaymentRatio > DEBT_RATIO_MAX) {
      debtRatioAlert.classList.remove('d-none');
    } else {
      debtRatioAlert.classList.add('d-none');
    }

    // 3) Future Value & Inflation
    const finalValue = estimateHousingValue(housingValue, housingIncrease, creditYears);
    document.getElementById('finalHousingValue').textContent = '€' + finalValue.toFixed(2);

    const inflationFactor = computeInflationFactor(inflationRate, creditYears);
    document.getElementById('inflationFactorLabel').textContent = inflationFactor.toFixed(2);

    // 4) Update Payment & Interest Chart
    const months = simulation.timelineData.map((t) => t.month);
    const remainingBalance = simulation.timelineData.map((t) => t.remainingBalance);
    const monthlyInterest = simulation.timelineData.map((t) => t.paidInterest);

    balanceChart.data.labels = months;
    balanceChart.data.datasets[0].data = remainingBalance;
    balanceChart.data.datasets[1].data = monthlyInterest;
    balanceChart.update();

    // 5) Rental ROI Computation
    // Occupancy-adjusted rent
    const rentIncome = (monthlyRent * (occupancyRate / 100));
    document.getElementById('adjustedRent').textContent = rentIncome.toFixed(2);

    // Net monthly cashflow from renting
    const netRentCashflow = rentIncome - monthlyExpenses - monthlyPayment;
    document.getElementById('rentCashflow').textContent = netRentCashflow.toFixed(2);
    // Basic ROI = (Net monthly profit / monthly Payment) * 100
    let rentROI = 0;
    if (monthlyPayment !== 0) {
      rentROI = (netRentCashflow / monthlyPayment) * 100;
    }
    document.getElementById('rentROI').textContent = rentROI.toFixed(2);

    // Approx. break-even in years if netRentCashflow is used to offset total interest
    let breakEvenYears = '-';
    if (netRentCashflow > 0) {
      breakEvenYears = (simulation.totalInterest / (netRentCashflow * 12)).toFixed(2);
    }
    document.getElementById('breakEvenRental').textContent = breakEvenYears;

    // 6) Calculate max loan possible with 37% ratio
    const maxLoan = calculateMaxLoan(monthlyIncome, interestRate, creditYears);
    document.getElementById('maxLoanPossible').textContent = '€' + maxLoan.toFixed(0);

    // 7) Build ROI Chart Data (Second Chart)
    // We generate month-by-month "cumulative interest" vs "cumulative rental profit"
    let cumulativeInterest = 0;
    let cumulativeRentalProfit = 0;
    const roiLabels = [];
    const interestData = [];
    const rentalProfitData = [];

    simulation.timelineData.forEach((item, idx) => {
      const mo = item.month;
      cumulativeInterest += item.paidInterest;
      // monthly net rent on that month (assuming same rent and occupancy each month)
      const monthlyNet = (rentIncome - monthlyExpenses - monthlyPayment);
      cumulativeRentalProfit += monthlyNet;
      roiLabels.push(mo);
      interestData.push(cumulativeInterest);
      rentalProfitData.push(cumulativeRentalProfit);
    });

    roiChart.data.labels = roiLabels;
    roiChart.data.datasets[0].data = interestData;
    roiChart.data.datasets[1].data = rentalProfitData;
    roiChart.update();

    // 8) Build recommendations
    const recommendationList = [];
    if (monthlyPaymentRatio > DEBT_RATIO_MAX) {
      recommendationList.push(
        `Your monthly payment (€${monthlyPayment.toFixed(2)}) is over 37% of your net income. 
         Consider lowering the principal or extending the credit term.`
      );
    } else {
      recommendationList.push(
        `Monthly payment (€${monthlyPayment.toFixed(2)}) is within the 37% ratio limit.`
      );
    }

    recommendationList.push(
      `Total interest over ${creditYears} years: €${totalInterest.toFixed(2)}. 
       Negotiating a lower interest rate or shorter duration can reduce this further.`
    );

    const netAppreciation = finalValue - housingValue;
    recommendationList.push(
      `Estimated apartment value after ${creditYears} years: €${finalValue.toFixed(2)} 
       (a gain of €${netAppreciation.toFixed(2)} vs. today's price, assuming 2% annual growth).`
    );

    recommendationList.push(
      `Inflation factor ~${inflationFactor.toFixed(2)}x in ${creditYears} years. 
       A stable loan rate can be advantageous as inflation rises.`
    );

    if (netRentCashflow < 0) {
      recommendationList.push(
        `Your net monthly rent cashflow is negative (€${netRentCashflow.toFixed(2)}). 
         Increase rent or reduce maintenance costs/property tax to achieve positive cashflow.`
      );
    } else {
      recommendationList.push(
        `Monthly net rental cashflow: €${netRentCashflow.toFixed(2)}, with an ROI of ${rentROI.toFixed(2)}%. 
         You'd offset the total interest in ~${breakEvenYears} years.`
      );
    }

    if (maxLoan < housingValue) {
      recommendationList.push(
        `Max affordable loan (~€${maxLoan.toFixed(2)}) is less than the apartment price (€${housingValue.toFixed(2)}). 
         Consider a higher down payment or better terms.`
      );
    } else {
      recommendationList.push(
        `You can likely afford this apartment with the current ratio. 
         The maximum you could borrow at these terms is about €${maxLoan.toFixed(2)}.`
      );
    }

    recommendationList.push(
      `Consider an emergency fund or buffer. Rental occupancy can fluctuate, and repairs can be higher than planned.`
    );

    // Update recommendations DOM
    const recElem = document.getElementById('recommendations');
    recElem.innerHTML = '';
    recommendationList.forEach((r) => {
      const li = document.createElement('li');
      li.textContent = r;
      recElem.appendChild(li);
    });
  }

  window.onload = function() {
    // Include optional user-provided inflation/housingIncrease if we want more user control
    // But let's keep them at default 2% for demonstration

    // Initialize the charts once
    initCharts();
    // Perform the first simulation
    updateSimulation();

    // Add event listeners for all inputs
    const inputIds = [
      "loanAmount",
      "monthlyIncome",
      "housingValue",
      "creditYears",
      "interestRate",
      "propertyTax",
      "monthlyRent",
      "monthlyExpenses",
      "occupancyRate"
    ];

    inputIds.forEach((id) => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener("input", updateSimulation);
      }
    });
  };
</script>
</body>
</html>
