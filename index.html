<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bank Credit Simulator with Rent Simulation</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #f8f9fa;
      margin-top: 20px;
    }

    .container {
      max-width: 1400px;
    }

    .card {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 8px;
    }

    .card-title {
      margin-bottom: 1rem;
      color: #007bff;
    }

    #chartContainer {
      position: relative;
      height: 320px;
      width: 100%;
    }
  </style>
</head>
<body>
<div class="container mb-4">
  <h1 class="text-center my-4">Bank Credit & Rental ROI Simulator</h1>

  <div class="row">
    <!-- Left Column: Inputs -->
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Loan & Income Parameters</h5>

          <!-- Loan Amount -->
          <div class="mb-3">
            <label for="loanAmount" class="form-label">Loan Amount (€)</label>
            <input type="number" class="form-control" id="loanAmount" value="200000"/>
          </div>

          <!-- Monthly Income -->
          <div class="mb-3">
            <label for="monthlyIncome" class="form-label">Monthly Income (Net) (€)</label>
            <input type="number" class="form-control" id="monthlyIncome" value="4000"/>
          </div>

          <!-- Credit Duration -->
          <div class="mb-3">
            <label for="creditYears" class="form-label">Credit Duration (Years)</label>
            <select class="form-select" id="creditYears">
              <option value="10">10 Years</option>
              <option value="15" selected>15 Years</option>
              <option value="20">20 Years</option>
            </select>
          </div>

          <!-- Interest Rate -->
          <div class="mb-3">
            <label for="interestRate" class="form-label">Interest Rate (%)</label>
            <input
              type="range"
              class="form-range"
              min="1"
              max="10"
              step="0.1"
              id="interestRate"
              value="3.7"
              oninput="document.getElementById('interestRateLabel').innerText = interestRate.value"
            />
            <div>
              Current: <span id="interestRateLabel">3.7</span>%
            </div>
          </div>

          <!-- Housing Value (For Max Loan Calculation or Down Payment Logic) -->
          <div class="mb-3">
            <label for="housingValue" class="form-label">Apartment Price or Value (€)</label>
            <input type="number" class="form-control" id="housingValue" value="250000"/>
          </div>

          <!-- Inflation Rate -->
          <div class="mb-3">
            <label for="inflationRate" class="form-label">Annual Inflation Rate (%)</label>
            <input
              type="range"
              class="form-range"
              min="0"
              max="10"
              step="0.1"
              id="inflationRate"
              value="2.0"
              oninput="document.getElementById('inflationRateLabel').innerText = inflationRate.value"
            />
            <div>
              Current: <span id="inflationRateLabel">2.0</span>%
            </div>
          </div>

          <!-- Housing Value Increase -->
          <div class="mb-3">
            <label for="housingIncrease" class="form-label">Annual Housing Value Increase (%)</label>
            <input
              type="range"
              class="form-range"
              min="0"
              max="10"
              step="0.1"
              id="housingIncrease"
              value="2.0"
              oninput="document.getElementById('housingIncreaseLabel').innerText = housingIncrease.value"
            />
            <div>
              Current: <span id="housingIncreaseLabel">2.0</span>%
            </div>
          </div>

          <button class="btn btn-primary w-100 mb-3" onclick="updateSimulation()">Simulate Credit</button>

          <!-- Max Loan Based on 37% Ratio -->
          <p class="small text-muted">
            Based on your monthly income & 37% limit, the maximum loan you can afford is: 
            <strong id="maxLoanPossible">€0</strong>.
          </p>
        </div>
      </div>

      <!-- Rental Parameters -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Rental Simulation</h5>
          <div class="mb-3">
            <label for="monthlyRent" class="form-label">Estimated Monthly Rent (€)</label>
            <input type="number" class="form-control" id="monthlyRent" value="800"/>
          </div>

          <div class="mb-3">
            <label for="monthlyExpenses" class="form-label">Monthly Expenses (Maintenance, Tax, etc.) (€)</label>
            <input type="number" class="form-control" id="monthlyExpenses" value="150"/>
          </div>

          <div class="mb-3">
            <label for="occupancyRate" class="form-label">Occupancy Rate (%)</label>
            <input
              type="range"
              class="form-range"
              min="0"
              max="100"
              step="1"
              id="occupancyRate"
              value="90"
              oninput="document.getElementById('occupancyRateLabel').innerText = occupancyRate.value"
            />
            <div>Current: <span id="occupancyRateLabel">90</span>%</div>
          </div>
          <button class="btn btn-secondary w-100" onclick="updateSimulation()">Simulate Rent ROI</button>
        </div>
      </div>
    </div>

    <!-- Right Column: Results -->
    <div class="col-md-8">
      <!-- Debt Ratio Alert -->
      <div id="debtRatioAlert" class="alert alert-warning d-none" role="alert">
        Your monthly payment exceeds the 37% debt-to-income ratio.
      </div>

      <!-- Key Results -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Key Results</h5>
          <p><strong>Monthly Payment:</strong> <span id="monthlyPayment">€0</span></p>
          <p><strong>Total Amount Paid (Principal + Interest):</strong> <span id="totalPaid">€0</span></p>
          <p><strong>Total Interest Paid:</strong> <span id="totalInterest">€0</span></p>
          <p><strong>Debt Ratio:</strong> <span id="debtRatio">0</span>% (Max allowed: 37%)</p>
          <p>
            <strong>Estimated Property Value after 
              <span id="creditYearsLabel">15</span> years:</strong>
            <span id="finalHousingValue">€0</span>
          </p>
          <p>
            <strong>Inflation Factor in 
              <span id="inflationYearsLabel">15</span> yrs:</strong>
            <span id="inflationFactorLabel">1.00</span>x
          </p>
        </div>
      </div>

      <!-- Chart -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Payment & Interest Timeline</h5>
          <div id="chartContainer">
            <canvas id="balanceChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Rental ROI Results -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title">Rental ROI Analysis</h5>
          <p>
            <strong>Monthly Rent (Occupancy-Adjusted):</strong> 
            €<span id="adjustedRent">0</span>
          </p>
          <p>
            <strong>Monthly Net Cashflow from Rent:</strong> 
            €<span id="rentCashflow">0</span> 
            (<span id="rentROI">0</span>% ROI vs monthly mortgage)
          </p>
          <p>
            <strong>Years to break-even on interest (approx.):</strong> 
            <span id="breakEvenRental">-</span> years
          </p>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Strategy Recommendations</h5>
          <ul id="recommendations"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let balanceChart;  // global Chart.js instance
  const DEBT_RATIO_MAX = 0.37; // 37% debt ratio

  function computeCreditSimulation(principal, annualInterestRate, creditYears) {
    /**
     * Amortization formula (monthly):
     * Payment = P * [r / (1 - (1 + r)^(-n))]
     * Where:
     *  P = principal
     *  r = monthly interest rate (annual interest / 12)
     *  n = total number of months
     */
    const monthlyRate = annualInterestRate / 100 / 12;
    const numberOfMonths = creditYears * 12;

    let monthlyPayment;
    if (monthlyRate === 0) {
      monthlyPayment = principal / numberOfMonths;
    } else {
      monthlyPayment = principal * (monthlyRate / (1 - Math.pow(1 + monthlyRate, -numberOfMonths)));
    }

    let remainingBalance = principal;
    let totalInterest = 0;
    const timelineData = [];

    for (let month = 1; month <= numberOfMonths; month++) {
      const interestThisMonth = remainingBalance * monthlyRate;
      const principalPaid = monthlyPayment - interestThisMonth;
      totalInterest += interestThisMonth;
      remainingBalance -= principalPaid;

      if (remainingBalance < 0) remainingBalance = 0;
      timelineData.push({
        month,
        remainingBalance,
        paidInterest: interestThisMonth,
      });

      if (remainingBalance <= 0) break;
    }

    const totalPaid = monthlyPayment * numberOfMonths;
    return {
      monthlyPayment,
      totalPaid,
      totalInterest,
      timelineData,
    };
  }

  function estimateHousingValue(currentValue, annualIncrease, years) {
    return currentValue * Math.pow(1 + annualIncrease / 100, years);
  }

  function computeInflationFactor(annualInflation, years) {
    return Math.pow(1 + annualInflation / 100, years);
  }

  function initChart() {
    const ctx = document.getElementById('balanceChart').getContext('2d');

    balanceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Remaining Balance',
            data: [],
            borderColor: 'rgb(75,192,192)',
            backgroundColor: 'rgba(75,192,192,0.2)',
            yAxisID: 'y',
            tension: 0.3,
          },
          {
            label: 'Interest Paid (Monthly)',
            data: [],
            borderColor: 'rgb(255,99,132)',
            backgroundColor: 'rgba(255,99,132,0.2)',
            yAxisID: 'y1',
            tension: 0.3,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            title: {
              display: true,
              text: 'Balance (€)',
            },
          },
          y1: {
            type: 'linear',
            position: 'right',
            title: {
              display: true,
              text: 'Interest (€)',
            },
            grid: {
              drawOnChartArea: false,
            },
          },
        },
      },
    });
  }

  function calculateMaxLoan(monthlyIncome, interestRate, creditYears) {
    /**
     * We want monthlyPayment / monthlyIncome <= 0.37
     * monthlyPayment = principal * (r / (1 - (1 + r)^(-n)))
     * Solve for principal given that monthlyPayment = monthlyIncome * 0.37
     */
    const monthlyRate = interestRate / 100 / 12;
    const numberOfMonths = creditYears * 12;
    const maxPayment = monthlyIncome * DEBT_RATIO_MAX;

    if (monthlyRate === 0) {
      // trivial case
      return maxPayment * numberOfMonths;
    }

    // Rearranged formula: 
    // principal = monthlyPayment * (1 - (1+r)^(-n)) / r
    // principal = maxPayment * ...
    const principal = maxPayment * (1 - Math.pow(1 + monthlyRate, -numberOfMonths)) / monthlyRate;
    return principal;
  }

  function updateSimulation() {
    // Collect inputs
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;
    const housingValue = parseFloat(document.getElementById('housingValue').value) || 0;
    const creditYears = parseInt(document.getElementById('creditYears').value, 10);

    const interestRate = parseFloat(document.getElementById('interestRate').value) || 3.7;
    const inflationRate = parseFloat(document.getElementById('inflationRate').value) || 2.0;
    const housingIncrease = parseFloat(document.getElementById('housingIncrease').value) || 2.0;

    const monthlyRent = parseFloat(document.getElementById('monthlyRent').value) || 0;
    const monthlyExpenses = parseFloat(document.getElementById('monthlyExpenses').value) || 0;
    const occupancyRate = parseFloat(document.getElementById('occupancyRate').value) || 0;

    // Update labels
    document.getElementById('creditYearsLabel').textContent = creditYears;
    document.getElementById('inflationYearsLabel').textContent = creditYears;

    // 1) Compute loan details
    const simulation = computeCreditSimulation(loanAmount, interestRate, creditYears);

    // 2) Update Key Results in DOM
    document.getElementById('monthlyPayment').textContent = '€' + simulation.monthlyPayment.toFixed(2);
    document.getElementById('totalPaid').textContent = '€' + simulation.totalPaid.toFixed(2);
    document.getElementById('totalInterest').textContent = '€' + simulation.totalInterest.toFixed(2);

    // Debt ratio
    const monthlyPaymentRatio = (simulation.monthlyPayment / monthlyIncome) || 0;
    document.getElementById('debtRatio').textContent = (monthlyPaymentRatio * 100).toFixed(2);

    // Debt ratio alert
    const debtRatioAlert = document.getElementById('debtRatioAlert');
    if (monthlyPaymentRatio > DEBT_RATIO_MAX) {
      debtRatioAlert.classList.remove('d-none');
    } else {
      debtRatioAlert.classList.add('d-none');
    }

    // 3) Housing & Inflation
    const finalValue = estimateHousingValue(housingValue, housingIncrease, creditYears);
    document.getElementById('finalHousingValue').textContent = '€' + finalValue.toFixed(2);

    const inflationFactor = computeInflationFactor(inflationRate, creditYears);
    document.getElementById('inflationFactorLabel').textContent = inflationFactor.toFixed(2);

    // 4) Update Chart Data
    const months = simulation.timelineData.map((t) => t.month);
    const remainingBalance = simulation.timelineData.map((t) => t.remainingBalance);
    const monthlyInterest = simulation.timelineData.map((t) => t.paidInterest);

    balanceChart.data.labels = months;
    balanceChart.data.datasets[0].data = remainingBalance;
    balanceChart.data.datasets[1].data = monthlyInterest;
    balanceChart.update();

    // 5) Rental ROI Computation
    // Occupancy-adjusted rent
    const rentIncome = (monthlyRent * (occupancyRate / 100));
    document.getElementById('adjustedRent').textContent = rentIncome.toFixed(2);

    // Net monthly cashflow from renting
    const netRentCashflow = rentIncome - monthlyExpenses - simulation.monthlyPayment;
    document.getElementById('rentCashflow').textContent = netRentCashflow.toFixed(2);
    // Basic ROI = (Net monthly profit / monthly Payment) * 100
    // This is naive but gives an idea
    let rentROI = 0;
    if (simulation.monthlyPayment !== 0) {
      rentROI = (netRentCashflow / simulation.monthlyPayment) * 100;
    }
    document.getElementById('rentROI').textContent = rentROI.toFixed(2);

    // Approx. break-even in years: total interest / net rent cashflow (assuming positive)
    let breakEvenYears = '-';
    if (netRentCashflow > 0) {
      breakEvenYears = (simulation.totalInterest / (netRentCashflow * 12)).toFixed(2);
    }
    document.getElementById('breakEvenRental').textContent = breakEvenYears;

    // 6) Calculate max loan possible with 37% ratio
    const maxLoan = calculateMaxLoan(monthlyIncome, interestRate, creditYears);
    document.getElementById('maxLoanPossible').textContent = '€' + maxLoan.toFixed(0);

    // 7) Build recommendations
    const recommendationList = [];

    // Debt ratio check
    if (monthlyPaymentRatio > DEBT_RATIO_MAX) {
      recommendationList.push(
        `Your monthly payment (€${simulation.monthlyPayment.toFixed(2)}) is over 37% of your net income. 
         Consider reducing the loan amount or extending the credit term for better negotiation.`
      );
    } else {
      recommendationList.push(
        `Monthly payment (€${simulation.monthlyPayment.toFixed(2)}) is within the 37% ratio limit.`
      );
    }

    // Interest total
    recommendationList.push(
      `Total interest over ${creditYears} years: €${simulation.totalInterest.toFixed(2)}. 
       Try negotiating a lower interest rate to reduce total interest paid.`
    );

    // Value appreciation
    const netAppreciation = finalValue - housingValue;
    recommendationList.push(
      `Estimated apartment value after ${creditYears} years: €${finalValue.toFixed(2)} 
       (a gain of €${netAppreciation.toFixed(2)} vs. today's price, assuming ${housingIncrease}% annual growth).`
    );

    recommendationList.push(
      `Inflation factor ~${inflationFactor.toFixed(2)}x in ${creditYears} years. 
       Money may lose purchasing power, so locking a low interest rate could be beneficial.`
    );

    // Rent recommendations
    if (netRentCashflow < 0) {
      recommendationList.push(`Your net monthly rent cashflow is negative (€${netRentCashflow.toFixed(2)}). 
        You may want to increase rent or reduce expenses to make renting profitable.`);
    } else {
      recommendationList.push(`Your monthly rent scenario yields a net of €${netRentCashflow.toFixed(2)}. 
        Rental ROI vs mortgage is ${rentROI.toFixed(2)}%. 
        Break-even on interest in ~${breakEvenYears} years.`);
    }

    if (maxLoan < housingValue) {
      recommendationList.push(`Your max affordable loan (~€${maxLoan.toFixed(2)}) is less than 
        the apartment price (€${housingValue}). You need a bigger down payment or additional financing.`);
    } else {
      recommendationList.push(`You can likely afford this apartment with the current 37% ratio. 
        The maximum you could borrow at these terms is about €${maxLoan.toFixed(2)}.`);
    }

    // Update recommendations DOM
    const recElem = document.getElementById('recommendations');
    recElem.innerHTML = '';
    recommendationList.forEach((r) => {
      const li = document.createElement('li');
      li.textContent = r;
      recElem.appendChild(li);
    });
  }

  window.onload = function() {
    // Initialize the chart once
    initChart();
    // Perform the first simulation run
    updateSimulation();

    // Add event listeners for all inputs to refresh the chart & ROI in real time
    const inputIds = [
      "loanAmount",
      "monthlyIncome",
      "housingValue",
      "creditYears",
      "interestRate",
      "inflationRate",
      "housingIncrease",
      "monthlyRent",
      "monthlyExpenses",
      "occupancyRate"
    ];

    inputIds.forEach((id) => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener("input", updateSimulation);
      }
    });
  };
</script>
</body>
</html>
