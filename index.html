<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bank Credit & Rental ROI Simulator</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />
  <!-- Chart.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
    body {
      background: linear-gradient(to top right, #f9fafb, #eef2f7);
      margin-top: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container {
      max-width: 1400px;
    }

    .card {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .section-header {
      color: #2d3748;
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-header i {
      color: #3182ce;
    }

    #chartContainer, #roiChartContainer {
      position: relative;
      height: 320px;
      width: 100%;
    }

    .badge-ratio {
      background-color: #dbeafe;
      color: #1e40af;
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
    }

    .alert-warning {
      margin-bottom: 1rem;
    }

    .recommendations {
      margin-top: 1rem;
      list-style: none;
      padding-left: 1rem;
    }
    .recommendations li::before {
      content: "• ";
      color: #007bff;
      font-weight: bold;
    }

    .scenario-card {
      transition: box-shadow 0.2s;
      margin-bottom: 1rem;
    }
    .scenario-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .scenario-card .card-body {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
  </style>
</head>
<body>
<div class="container mb-4">
  <h1 class="text-center my-4" style="color: #2d3748;">
    <i class="bi bi-bank"></i> Bank Credit &amp; Rental ROI Simulator (Income Re-Injection + Overdrive)
  </h1>

  <!-- Nav Tabs -->
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="single-tab"
        data-bs-toggle="tab"
        data-bs-target="#singleScenario"
        type="button"
        role="tab"
      >
        Single Scenario
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="multi-tab"
        data-bs-toggle="tab"
        data-bs-target="#multiScenario"
        type="button"
        role="tab"
      >
        Multiple Scenarios
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="strategy-tab"
        data-bs-toggle="tab"
        data-bs-target="#strategyTab"
        type="button"
        role="tab"
      >
        Break-Even Strategies
      </button>
    </li>
  </ul>

  <div class="tab-content" id="mainTabContent">

    <!-- Single Scenario Tab -->
    <div
      class="tab-pane fade show active"
      id="singleScenario"
      role="tabpanel"
      aria-labelledby="single-tab"
    >
      <div class="row mt-4">
        <!-- Left Column -->
        <div class="col-md-4">
          <!-- Single Scenario Card -->
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="section-header">
                <i class="bi bi-cash-stack"></i> Loan &amp; Income Parameters
              </h5>

              <!-- Property Price -->
              <div class="mb-3">
                <label for="housingValue" class="form-label">Property Price (EUR)</label>
                <input type="number" class="form-control" id="housingValue" value="250000"/>
              </div>

              <!-- Manual Down Payment -->
              <div class="mb-3">
                <label for="manualDownPayment" class="form-label">Manual Down Payment (EUR)</label>
                <input type="number" class="form-control" id="manualDownPayment" value="25000"/>
                <small class="text-muted">Minimum 10% recommended in France</small>
              </div>

              <!-- Notary Fees -->
              <div class="mb-3">
                <label for="notaryFeesRate" class="form-label">Notary Fees Rate (%)</label>
                <input
                  type="range"
                  class="form-range"
                  min="5"
                  max="10"
                  step="0.5"
                  id="notaryFeesRate"
                  value="8"
                  oninput="document.getElementById('notaryFeesRateLabel').innerText = notaryFeesRate.value"
                />
                <div>
                  Current: <span id="notaryFeesRateLabel">8</span>%
                </div>
              </div>

              <!-- Loan Insurance Rate -->
              <div class="mb-3">
                <label for="insuranceRate" class="form-label">Loan Insurance Rate (% per year)</label>
                <input
                  type="range"
                  class="form-range"
                  min="0"
                  max="1"
                  step="0.05"
                  id="insuranceRate"
                  value="0.3"
                  oninput="document.getElementById('insuranceRateLabel').innerText = insuranceRate.value"
                />
                <div>
                  Current: <span id="insuranceRateLabel">0.3</span>%
                </div>
              </div>

              <!-- Monthly Income -->
              <div class="mb-3">
                <label for="monthlyIncome" class="form-label">Monthly Income (Net, EUR)</label>
                <input type="number" class="form-control" id="monthlyIncome" value="7000"/>
              </div>

              <!-- Credit Duration -->
              <div class="mb-3">
                <label for="creditYears" class="form-label">Credit Duration (Years)</label>
                <select class="form-select" id="creditYears">
                  <option value="10">10 Years</option>
                  <option value="15">15 Years</option>
                  <option value="20">20 Years</option>
                  <option value="25" selected>25 Years</option>
                </select>
              </div>

              <!-- Interest Rate -->
              <div class="mb-3">
                <label for="interestRateSingle" class="form-label">Interest Rate (%)</label>
                <input
                  type="range"
                  class="form-range"
                  min="1"
                  max="15"
                  step="0.1"
                  id="interestRateSingle"
                  value="10"
                  oninput="document.getElementById('interestRateSingleLabel').innerText = interestRateSingle.value"
                />
                <div>
                  Current: <span id="interestRateSingleLabel">10</span>%
                </div>
              </div>

              <!-- Payment Overdrive -->
              <div class="mb-3">
                <label for="paymentOverdrive" class="form-label">Payment Overdrive (%)</label>
                <input
                  type="range"
                  class="form-range"
                  min="0"
                  max="100"
                  step="5"
                  id="paymentOverdrive"
                  value="35"
                  oninput="document.getElementById('paymentOverdriveLabel').innerText = paymentOverdrive.value"
                />
                <div>
                  Current: <span id="paymentOverdriveLabel">35</span>%
                </div>
              </div>

              <!-- Income Re-Injection -->
              <div class="mb-3">
                <label for="incomeInjection" class="form-label">Income Re-Injection (% of Net Income)</label>
                <input
                  type="range"
                  class="form-range"
                  min="0"
                  max="50"
                  step="5"
                  id="incomeInjection"
                  value="0"
                  oninput="document.getElementById('incomeInjectionLabel').innerText = incomeInjection.value"
                />
                <div>
                  Current: <span id="incomeInjectionLabel">0</span>%
                </div>
                <small class="text-muted">Extra portion of monthly income to put into mortgage each month</small>
              </div>

              <!-- Monthly Property Tax / Insurance -->
              <div class="mb-3">
                <label for="propertyTax" class="form-label">Property Tax / Insurance (monthly, EUR)</label>
                <input type="number" class="form-control" id="propertyTax" value="100"/>
              </div>

              <p class="small text-muted mb-0">
                <i class="bi bi-calculator"></i> Max loan @ 37% ratio:
                <strong id="maxLoanPossible">€0</strong>.
              </p>
            </div>
          </div>

          <!-- Rental Simulation -->
          <div class="card">
            <div class="card-body">
              <h5 class="section-header">
                <i class="bi bi-house-fill"></i> Rental ROI Parameters
              </h5>
              <div class="mb-3">
                <label for="monthlyRent" class="form-label">Monthly Rent (EUR)</label>
                <input type="number" class="form-control" id="monthlyRent" value="1500"/>
              </div>

              <div class="mb-3">
                <label for="monthlyExpenses" class="form-label">Maint. &amp; Utilities (EUR)</label>
                <input type="number" class="form-control" id="monthlyExpenses" value="150"/>
              </div>

              <div class="mb-3">
                <label for="occupancyRate" class="form-label">Occupancy Rate (%)</label>
                <input
                  type="range"
                  class="form-range"
                  min="0"
                  max="100"
                  step="1"
                  id="occupancyRate"
                  value="90"
                  oninput="document.getElementById('occupancyRateLabel').innerText = occupancyRate.value"
                />
                <div>Current: <span id="occupancyRateLabel">90</span>%</div>
              </div>
            </div>
          </div>
        </div><!-- Left Column -->

        <!-- Right Column: Results & Charts -->
        <div class="col-md-8">
          <!-- Debt Ratio Alert -->
          <div id="debtRatioAlert" class="alert alert-warning d-none" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            Your monthly payment exceeds the 37% debt-to-income ratio.
          </div>

          <!-- Key Results -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="section-header">
                <i class="bi bi-speedometer2"></i>
                <span>Key Results</span>
              </div>
              <p><strong>Calculated Loan Amount:</strong> <span id="calculatedLoanAmount">€0</span></p>
              <p><strong>Monthly Payment (Overdrive + Income Injection):</strong> <span id="monthlyPayment">€0</span></p>
              <p><strong>Total Paid (Principal + Interest + Insurance):</strong> <span id="totalPaid">€0</span></p>
              <p><strong>Total Interest Paid:</strong> <span id="totalInterest">€0</span></p>
              <p>
                <strong>Debt Ratio:</strong>
                <span id="debtRatio" class="badge-ratio">0</span>% (Max allowed: 37%)
              </p>
              <p>
                <strong>Estimated Property Value after
                  <span id="creditYearsLabel">25</span> years:</strong>
                <span id="finalHousingValue">€0</span>
              </p>
              <p>
                <strong>Inflation Factor in
                  <span id="inflationYearsLabel">25</span> yrs:</strong>
                <span id="inflationFactorLabel">1.00</span>x
              </p>
            </div>
          </div>

          <!-- Chart Accordion -->
          <div class="accordion" id="chartExplanations">
            <!-- Payment & Interest Timeline Card -->
            <div class="accordion-item card">
              <h2 class="accordion-header" id="headingPaymentChart">
                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapsePaymentChart" aria-expanded="true" aria-controls="collapsePaymentChart">
                  <div class="section-header mb-0" style="gap: 0.5rem;">
                    <i class="bi bi-bar-chart-line-fill"></i> Payment &amp; Interest Timeline
                  </div>
                </button>
              </h2>
              <div id="collapsePaymentChart" class="accordion-collapse collapse show"
                aria-labelledby="headingPaymentChart" data-bs-parent="#chartExplanations">
                <div class="accordion-body">
                  <div id="chartContainer">
                    <canvas id="balanceChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <!-- ROI & Break-Even Card -->
            <div class="accordion-item card">
              <h2 class="accordion-header" id="headingROIChart">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseROIChart" aria-expanded="false" aria-controls="collapseROIChart">
                  <div class="section-header mb-0" style="gap: 0.5rem;">
                    <i class="bi bi-piggy-bank-fill"></i> Break-Even &amp; ROI Analysis
                  </div>
                </button>
              </h2>
              <div id="collapseROIChart" class="accordion-collapse collapse"
                aria-labelledby="headingROIChart" data-bs-parent="#chartExplanations">
                <div class="accordion-body">
                  <div id="roiChartContainer">
                    <canvas id="roiChart"></canvas>
                  </div>
                </div>
              </div>
            </div><!-- End ROI Chart Accordion Item -->
          </div><!-- End Chart Accordion -->

          <!-- Rental ROI -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="section-header">
                <i class="bi bi-house-door-fill"></i>
                <span>Rental ROI Details</span>
              </div>
              <p><strong>Monthly Rent (Occupancy-Adjusted):</strong> <span id="adjustedRent">€0</span></p>
              <p><strong>Monthly Net Cashflow:</strong> <span id="rentCashflow">€0</span> 
                (<span id="rentROI">0</span>% ROI)
              </p>
              <p><strong>Break-Even on Interest:</strong> <span id="breakEvenRental">-</span> years</p>
            </div>
          </div>

          <!-- Recommendations -->
          <div class="card">
            <div class="card-body">
              <div class="section-header">
                <i class="bi bi-lightbulb-fill"></i>
                <span>Strategy Recommendations</span>
              </div>
              <ul class="recommendations" id="recommendations"></ul>
            </div>
          </div>
        </div><!-- Right Column -->
      </div><!-- row -->
    </div><!-- End Single Scenario Tab -->

    <!-- Multiple Scenarios Tab -->
    <div
      class="tab-pane fade"
      id="multiScenario"
      role="tabpanel"
      aria-labelledby="multi-tab"
    >
      <div class="mt-4">
        <h3 class="mb-3">
          <i class="bi bi-diagram-3"></i> Multiple Scenarios
        </h3>
        <p class="text-muted">
          Compare 10, 15, 20, 25-year mortgages side by side. Overdrive + Income Re-Injection also applies. Each card shows break-even estimate.
        </p>
        <div class="row" id="scenarioCards"></div>
      </div>
    </div><!-- End MultiScenario Tab -->

    <!-- Break-Even Strategies Tab -->
    <div
      class="tab-pane fade"
      id="strategyTab"
      role="tabpanel"
      aria-labelledby="strategy-tab"
    >
      <div class="mt-4">
        <h3 class="mb-3">
          <i class="bi bi-lightning"></i> Break-Even Strategies
        </h3>
        <p class="text-muted">
          Tries feasible Overdrive and Income Re-Injection combos (in steps of 5%) up to ratio-limited maximum, 
          listing fastest break-even solutions that remain under 37% debt ratio.
        </p>
        <div class="row" id="strategyCards"></div>
      </div>
    </div><!-- End Break-Even Strategies Tab -->

  </div><!-- End mainTabContent -->
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /****************************
   * GLOBALS
   ****************************/
  const DEBT_RATIO_MAX = 0.37;
  const DEFAULT_INFLATION = 2.0;
  const DEFAULT_HOUSING_INCREASE = 2.0;

  let balanceChart;
  let roiChart;

  /****************************
   * breakEvenPlugin
   ****************************/
  const breakEvenPlugin = {
    id: 'breakEvenPlugin',
    afterDatasetsDraw(chart, args, pluginOptions) {
      const breakEvenIndex = pluginOptions?.breakEvenIndex;
      if (!breakEvenIndex) return;
      const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
      const labelCount = chart.data.labels.length;
      if (labelCount===0 || breakEvenIndex<=0) return;
      if (breakEvenIndex>labelCount) return;

      ctx.save();
      ctx.beginPath();
      ctx.setLineDash([6,6]);
      ctx.strokeStyle='rgb(75,192,192)';
      ctx.lineWidth=2;
      const xPos = x.getPixelForValue(breakEvenIndex);
      ctx.moveTo(xPos, top);
      ctx.lineTo(xPos, bottom);
      ctx.stroke();

      const labelText = `Break-Even (Month ${breakEvenIndex})`;
      ctx.font='bold 12px "Segoe UI",sans-serif';
      const textWidth= ctx.measureText(labelText).width+10;
      const labelX= xPos - (textWidth/2);
      const labelY= top+10;
      ctx.fillStyle='rgba(75,192,192,0.8)';
      ctx.fillRect(labelX,labelY,textWidth,20);
      ctx.fillStyle='#fff';
      ctx.fillText(labelText,labelX+5,labelY+14);
      ctx.restore();
    }
  };

  /****************************
   * kFormat
   ****************************/
  function kFormat(value) {
    if(Math.abs(value)>=1000){
      const v= (value/1000).toFixed(1);
      return v+'k EUR';
    }
    return '€'+value.toFixed(2);
  }

  /****************************
   * initCharts
   ****************************/
  function initCharts() {
    const ctx1= document.getElementById('balanceChart').getContext('2d');
    balanceChart= new Chart(ctx1,{
      type:'line',
      data:{
        labels:[],
        datasets:[
          {
            label:'Remaining Balance (EUR)',
            data:[],
            borderColor:'rgb(75,192,192)',
            backgroundColor:'rgba(75,192,192,0.2)',
            tension:0.3,
            fill:true,
            yAxisID:'y'
          },
          {
            label:'Monthly Interest (EUR)',
            data:[],
            borderColor:'rgb(255,99,132)',
            backgroundColor:'rgba(255,99,132,0.2)',
            tension:0.3,
            fill:true,
            yAxisID:'y1'
          },
        ],
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{
            type:'linear',
            position:'left',
            title:{display:true,text:'Balance (EUR)'},
            ticks:{
              callback:(val)=> kFormat(val),
            }
          },
          y1:{
            type:'linear',
            position:'right',
            title:{display:true,text:'Interest (EUR)'},
            grid:{drawOnChartArea:false},
            ticks:{
              callback:(val)=> kFormat(val),
            }
          },
        },
      }
    });

    const ctx2= document.getElementById('roiChart').getContext('2d');
    roiChart= new Chart(ctx2, {
      type:'line',
      data:{
        labels:[],
        datasets:[
          {
            label:'Cumulative Interest (EUR)',
            data:[],
            borderColor:'rgb(255,159,64)',
            backgroundColor:'rgba(255,159,64,0.2)',
            tension:0.3,
            fill:true,
          },
          {
            label:'Cumulative Rental Profit (EUR)',
            data:[],
            borderColor:'rgb(54,162,235)',
            backgroundColor:'rgba(54,162,235,0.2)',
            tension:0.3,
            fill:true,
          },
        ],
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          breakEvenPlugin:{breakEvenIndex:0}
        },
        scales:{
          y:{
            beginAtZero:true,
            title:{display:true,text:'Cumulative Amount (EUR)'},
            ticks:{
              callback:(val)=>kFormat(val),
            }
          }
        },
      },
      plugins:[breakEvenPlugin],
    });
  }

  /****************************
   * gatherInputs
   ****************************/
  function gatherInputs() {
    return {
      propertyPrice: parseFloat(document.getElementById('housingValue').value)||0,
      manualDownPayment: parseFloat(document.getElementById('manualDownPayment').value)||0,
      notaryFeesRate: parseFloat(document.getElementById('notaryFeesRate').value)||8,
      insuranceYearlyRate: parseFloat(document.getElementById('insuranceRate').value)||0.3,
      monthlyIncome: parseFloat(document.getElementById('monthlyIncome').value)||0,
      creditYears: parseInt(document.getElementById('creditYears').value)||15,
      interestRateSingle: parseFloat(document.getElementById('interestRateSingle').value)||3.7,
      paymentOverdrive: parseFloat(document.getElementById('paymentOverdrive').value)||0,
      incomeInjection: parseFloat(document.getElementById('incomeInjection').value)||0,
      propertyTax: parseFloat(document.getElementById('propertyTax').value)||100,
      monthlyRent: parseFloat(document.getElementById('monthlyRent').value)||0,
      monthlyExpenses: parseFloat(document.getElementById('monthlyExpenses').value)||0,
      occupancyRate: parseFloat(document.getElementById('occupancyRate').value)||0,
    };
  }

  /****************************
   * computeMonthlyPayment
   ****************************/
  function computeMonthlyPayment(principal, annualInterestRate, creditYears) {
    const monthlyRate = annualInterestRate/100/12;
    const numberOfMonths= creditYears*12;
    if(monthlyRate===0)return principal/numberOfMonths;
    return principal*(monthlyRate/(1-Math.pow(1+monthlyRate, -numberOfMonths)));
  }

  /****************************
   * calcMaxLoan
   ****************************/
  function calcMaxLoan(inp) {
    /**
     * finalPayment= monthlyPaymentPI*(1+Overdrive%) + monthlyInsurance + propertyTax + (monthlyIncome*(incomeInjection%/100))
     * ratio check => finalPayment <= monthlyIncome* DEBT_RATIO_MAX
     */
    const maxRatioPayment = inp.monthlyIncome* DEBT_RATIO_MAX;
    let low=0, high=2_000_000, principal=0;
    for(let i=0;i<50;i++){
      const mid=(low+high)/2;
      const monthlyPaymentPI= computeMonthlyPayment(mid, inp.interestRateSingle, inp.creditYears);
      const monthlyPaymentPIOverdrive= monthlyPaymentPI*(1+inp.paymentOverdrive/100);
      const monthlyInsurance= mid*(inp.insuranceYearlyRate/100)/12;
      const injection= inp.monthlyIncome*(inp.incomeInjection/100);
      const finalPayment= monthlyPaymentPIOverdrive+ monthlyInsurance+ inp.propertyTax + injection;

      if(finalPayment> maxRatioPayment) {
        high=mid;
      } else {
        low=mid;
      }
      principal=low;
    }
    return principal;
  }

  /****************************
   * buildRecommendations
   ****************************/
  function buildRecommendations(data, timelineMonths) {
    const recElem=document.getElementById('recommendations');
    recElem.innerHTML='';
    let recs=[];

    if(data.manualDownPayment< (data.propertyPrice*0.1)) {
      recs.push(`Down payment €${data.manualDownPayment.toFixed(2)} < 10% of property price €${data.propertyPrice.toFixed(2)}. 
       Typically 10%+ is required in France.`);
    }

    if(data.debtRatio>DEBT_RATIO_MAX){
      recs.push(`Your monthly payment €${data.finalMonthlyPayment.toFixed(2)} >37% net income. 
       Lower Overdrive or Injection or reduce principal.`);
    } else {
      recs.push(`Monthly payment (~${kFormat(data.finalMonthlyPayment)}) is within the 37% ratio limit.`);
    }

    recs.push(`Total interest: ~${kFormat(data.totalInterest)}. 
      Insurance adds ~${kFormat(data.monthlyInsurance*timelineMonths)}. 
      Overdrive +${data.paymentOverdrive}%, Income Injection +${data.incomeInjection}%.`);

    const netAppreciation= data.finalValue- data.propertyPrice;
    recs.push(`Estimated property value after credit: ~${kFormat(data.finalValue)} 
      (gain ~€${netAppreciation.toFixed(2)}). 
      Extra injection from monthly income shortens payoff timeline.`);

    if(data.netRentCashflow<0){
      recs.push(`Monthly net rent CF is negative (€${data.netRentCashflow.toFixed(2)}). 
       Consider higher injection or Overdrive if finances allow.`);
    } else {
      recs.push(`Net rent CF: €${data.netRentCashflow.toFixed(2)}, ROI: ${data.rentROI.toFixed(2)}%. 
       Break-even in ~${data.breakEvenYears} yrs.`);
    }

    if(data.maxLoan< data.propertyPrice){
      recs.push(`Max affordable loan ~${kFormat(data.maxLoan)} < property price ~${kFormat(data.propertyPrice)}. 
        Raise down payment or reduce Overdrive/Injection demands.`);
    } else {
      recs.push(`You can afford this property under 37% ratio. Max loan ~${kFormat(data.maxLoan)}.`);
    }

    recs.push(`Notary fees ~${(data.notaryFees).toFixed(2)} EUR. Overdrive + income injection can drastically lower interest 
      but ensure your monthly finances remain stable.`);

    recs.forEach(r=>{
      const li=document.createElement('li');
      li.textContent=r;
      recElem.appendChild(li);
    });
  }

  /****************************
   * updateSingleScenario
   ****************************/
  function updateSingleScenario() {
    const inp=gatherInputs();
    const notaryFees = inp.propertyPrice* (inp.notaryFeesRate/100);
    const borrowedPrincipal= Math.max(inp.propertyPrice-inp.manualDownPayment,0);

    // baseline monthly P+I
    const monthlyPaymentPI= computeMonthlyPayment(borrowedPrincipal, inp.interestRateSingle, inp.creditYears);
    const monthlyPaymentPIOverdrive= monthlyPaymentPI*(1+ inp.paymentOverdrive/100);
    const monthlyInsurance= borrowedPrincipal*(inp.insuranceYearlyRate/100)/12;
    // additional injection from monthly income
    const monthlyIncomeInjection= inp.monthlyIncome*(inp.incomeInjection/100);

    const finalMonthlyPayment= monthlyPaymentPIOverdrive + monthlyInsurance + inp.propertyTax + monthlyIncomeInjection;

    // payoff loop ignoring nominal creditYears, as Overdrive + injection shortens term
    let timelineData=[];
    let monthsCount=0;
    let remainingBalance= borrowedPrincipal;
    let totalInterest=0;
    const monthlyRate= inp.interestRateSingle/100/12;

    while(remainingBalance>0 && monthsCount<600){
      monthsCount++;
      const interestThisMonth= remainingBalance*monthlyRate;
      totalInterest+=interestThisMonth;
      let principalPaid= (monthlyPaymentPIOverdrive + monthlyIncomeInjection) - interestThisMonth;
      if(principalPaid<0) principalPaid=0;
      remainingBalance-= principalPaid;
      if(remainingBalance<0) remainingBalance=0;
      timelineData.push({month:monthsCount, paidInterest:interestThisMonth, remainingBalance});
      if(remainingBalance<=0) break;
    }

    const totalInsurance= monthlyInsurance* monthsCount;
    const totalTax= inp.propertyTax* monthsCount;
    const totalPI= (monthlyPaymentPIOverdrive+ monthlyIncomeInjection)* monthsCount;
    const totalPaid= totalPI+ totalInsurance+ totalTax;

    document.getElementById('calculatedLoanAmount').textContent= kFormat(borrowedPrincipal);
    document.getElementById('monthlyPayment').textContent= kFormat(finalMonthlyPayment);
    document.getElementById('totalPaid').textContent= kFormat(totalPaid);
    document.getElementById('totalInterest').textContent= kFormat(totalInterest);

    // ratio
    const ratio= (inp.monthlyIncome>0)? (finalMonthlyPayment/inp.monthlyIncome):0;
    document.getElementById('debtRatio').textContent= (ratio*100).toFixed(2);
    const debtRatioAlert= document.getElementById('debtRatioAlert');
    if(ratio> DEBT_RATIO_MAX) debtRatioAlert.classList.remove('d-none');
    else debtRatioAlert.classList.add('d-none');

    document.getElementById('creditYearsLabel').textContent= inp.creditYears;
    document.getElementById('inflationYearsLabel').textContent= inp.creditYears;
    const finalValue= inp.propertyPrice* Math.pow(1+ DEFAULT_HOUSING_INCREASE/100, inp.creditYears);
    document.getElementById('finalHousingValue').textContent= kFormat(finalValue);
    const inflationFactor= Math.pow(1+ DEFAULT_INFLATION/100, inp.creditYears);
    document.getElementById('inflationFactorLabel').textContent= inflationFactor.toFixed(2);

    // Payment & Interest Chart
    balanceChart.data.labels= timelineData.map(t=>t.month);
    balanceChart.data.datasets[0].data= timelineData.map(t=> t.remainingBalance);
    balanceChart.data.datasets[1].data= timelineData.map(t=> t.paidInterest);
    balanceChart.update();

    // ROI Chart
    const rentIncome= inp.monthlyRent*(inp.occupancyRate/100);
    const netRentCashflow= rentIncome- inp.monthlyExpenses- finalMonthlyPayment;

    document.getElementById('adjustedRent').textContent= kFormat(rentIncome);
    document.getElementById('rentCashflow').textContent= netRentCashflow.toFixed(2);

    let rentROI=0;
    if(finalMonthlyPayment>0) rentROI= (netRentCashflow/finalMonthlyPayment)*100;

    let roiTimeline=[];
    let cumInterest=0, cumProfit=0;
    let breakEvenIndex=-1;

    for(let i=0;i<timelineData.length;i++){
      cumInterest+= timelineData[i].paidInterest;
      // monthly net includes negative or positive monthly difference
      cumProfit+= netRentCashflow;
      roiTimeline.push({month: timelineData[i].month, cumInterest, cumProfit});
      if(breakEvenIndex<0 && cumProfit>=cumInterest){
        breakEvenIndex= timelineData[i].month;
      }
    }

    roiChart.data.labels= roiTimeline.map(t=> t.month);
    roiChart.data.datasets[0].data= roiTimeline.map(t=> t.cumInterest);
    roiChart.data.datasets[1].data= roiTimeline.map(t=> t.cumProfit);

    let lineIndex=(breakEvenIndex>0)? breakEvenIndex: roiTimeline.length+1;
    roiChart.options.plugins.breakEvenPlugin.breakEvenIndex=lineIndex;
    roiChart.update();

    let breakEvenYears='-';
    if(netRentCashflow>0) {
      breakEvenYears=(totalInterest/(netRentCashflow*12)).toFixed(2);
    }
    document.getElementById('breakEvenRental').textContent= breakEvenYears;

    // more realistic maxLoan
    const maxLoanVal= calcMaxLoan(inp);
    document.getElementById('maxLoanPossible').textContent= kFormat(maxLoanVal);

    // recommendations
    buildRecommendations({
      manualDownPayment: inp.manualDownPayment,
      propertyPrice: inp.propertyPrice,
      finalMonthlyPayment,
      borrowedPrincipal,
      monthlyInsurance,
      totalInterest,
      finalValue,
      netRentCashflow,
      rentROI,
      breakEvenYears,
      notaryFees,
      debtRatio: ratio,
      paymentOverdrive: inp.paymentOverdrive,
      incomeInjection: inp.incomeInjection,
      maxLoan: maxLoanVal
    }, timelineData.length);

    // multi scenario
    buildMultiScenarios();
    // strategy tab
    buildStrategyTab();
  }

  /****************************
   * buildMultiScenarios
   ****************************/
  function buildMultiScenarios() {
    const inp=gatherInputs();
    const scenarioCards=document.getElementById('scenarioCards');
    scenarioCards.innerHTML='';

    const durations=[10,15,20,25];
    const borrowedPrincipal= Math.max(inp.propertyPrice- inp.manualDownPayment,0);

    durations.forEach(dy=>{
      const monthlyPaymentPI= computeMonthlyPayment(borrowedPrincipal, inp.interestRateSingle, dy);
      const monthlyPaymentPIOverdrive= monthlyPaymentPI*(1+ inp.paymentOverdrive/100);
      const monthlyInsurance= borrowedPrincipal*(inp.insuranceYearlyRate/100)/12;
      const monthlyIncomeInjection= inp.monthlyIncome*(inp.incomeInjection/100);

      const finalMonthlyPayment= monthlyPaymentPIOverdrive+ monthlyInsurance+ inp.propertyTax + monthlyIncomeInjection;

      let timelineData=[];
      let monthsCount=0;
      let remainingBalance= borrowedPrincipal;
      let totalInterest=0;
      const monthlyRate= inp.interestRateSingle/100/12;

      while(remainingBalance>0 && monthsCount<600){
        monthsCount++;
        const interestThisMonth= remainingBalance* monthlyRate;
        totalInterest+= interestThisMonth;
        let principalPaid= monthlyPaymentPIOverdrive + monthlyIncomeInjection - interestThisMonth;
        if(principalPaid<0) principalPaid=0;
        remainingBalance-= principalPaid;
        if(remainingBalance<0) remainingBalance=0;
        timelineData.push({month:monthsCount, remainingBalance, paidInterest:interestThisMonth});
        if(remainingBalance<=0) break;
      }

      const totalInsurance= monthsCount* monthlyInsurance;
      const totalTax= monthsCount* inp.propertyTax;
      const totalPI= monthsCount*(monthlyPaymentPIOverdrive+ monthlyIncomeInjection);
      const totalPaid= totalPI+ totalInsurance+ totalTax;

      const ratio= (inp.monthlyIncome>0)? (finalMonthlyPayment/inp.monthlyIncome): 0;
      const ratioExceeded= ratio> DEBT_RATIO_MAX;

      const rentIncome= inp.monthlyRent*(inp.occupancyRate/100);
      const netRentCashflow= rentIncome- inp.monthlyExpenses - finalMonthlyPayment;

      let breakEvenYears='-';
      if(netRentCashflow>0){
        breakEvenYears= (totalInterest/(netRentCashflow*12)).toFixed(2);
      }

      let rentROI=0;
      if(finalMonthlyPayment>0) rentROI=(netRentCashflow/finalMonthlyPayment)*100;

      const cardDiv= document.createElement('div');
      cardDiv.className='col-md-6 col-lg-3';
      cardDiv.innerHTML=`
        <div class="card scenario-card h-100 border-${ratioExceeded?'danger':'success'}">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-stopwatch"></i> ${dy}-Year + Ovr ${inp.paymentOverdrive}% + Inj ${inp.incomeInjection}%
            </h5>
            <p><strong>Principal:</strong> ${kFormat(borrowedPrincipal)}</p>
            <p><strong>Monthly Pay:</strong> ${kFormat(finalMonthlyPayment)}</p>
            <p><strong>Term (approx.):</strong> ${monthsCount} months (~${(monthsCount/12).toFixed(1)} yrs)</p>
            <p><strong>Total Paid:</strong> ${kFormat(totalPaid)}</p>
            <p><strong>Total Interest:</strong> ${kFormat(totalInterest)}</p>
            <p class="${ratioExceeded?'text-danger':'text-success'}">
              <strong>Debt Ratio:</strong> ${(ratio*100).toFixed(2)}%
            </p>
            <p><strong>Net Rent CF:</strong> €${netRentCashflow.toFixed(2)} (ROI: ${rentROI.toFixed(2)}%)</p>
            <p><strong>Break-Even:</strong> ${breakEvenYears} yrs</p>
          </div>
        </div>
      `;
      scenarioCards.appendChild(cardDiv);
    });
  }

  /****************************
   * buildStrategyTab
   ****************************/
  function buildStrategyTab() {
    /**
     * systematically tries Overdrive=0..100 step 5
     * IncomeInj=0..50 step 5
     * check ratio constraint, pick best break-even
     */
    const container= document.getElementById('strategyCards');
    container.innerHTML='';

    const inp= gatherInputs();
    const borrowedPrincipal= Math.max(inp.propertyPrice - inp.manualDownPayment,0);
    let combos=[];

    for(let od=0; od<=100; od+=5){
      for(let inj=0; inj<=50; inj+=5){
        // final monthly
        const monthlyPaymentPI= computeMonthlyPayment(borrowedPrincipal, inp.interestRateSingle, inp.creditYears);
        const monthlyPaymentPIOverdrive= monthlyPaymentPI*(1+od/100);
        const monthlyInsurance= borrowedPrincipal*(inp.insuranceYearlyRate/100)/12;
        const monthlyIncomeInjection= inp.monthlyIncome*(inj/100);

        const finalMonthlyPayment= monthlyPaymentPIOverdrive+ monthlyInsurance+ inp.propertyTax+ monthlyIncomeInjection;
        const ratio= (inp.monthlyIncome>0)?(finalMonthlyPayment/inp.monthlyIncome):0;
        if(ratio<= DEBT_RATIO_MAX) {
          // payoff loop
          let timelineData=[];
          let monthsCount=0;
          let remainingBalance= borrowedPrincipal;
          let totalInterest=0;
          const monthlyRate= inp.interestRateSingle/100/12;

          while(remainingBalance>0 && monthsCount<600){
            monthsCount++;
            const interestThisMonth= remainingBalance*monthlyRate;
            totalInterest+= interestThisMonth;
            let principalPaid= monthlyPaymentPIOverdrive+ monthlyIncomeInjection - interestThisMonth;
            if(principalPaid<0) principalPaid=0;
            remainingBalance-= principalPaid;
            if(remainingBalance<0) remainingBalance=0;
            timelineData.push({month:monthsCount, paidInterest:interestThisMonth});
            if(remainingBalance<=0) break;
          }

          // net rent
          const rentIncome= inp.monthlyRent*(inp.occupancyRate/100);
          const netRentCashflow= rentIncome- inp.monthlyExpenses - finalMonthlyPayment;
          let breakEvenYears='-';
          if(netRentCashflow>0){
            // sum interest
            let totalInt=0;
            timelineData.forEach(t=> totalInt+= t.paidInterest);
            breakEvenYears= (totalInt/(netRentCashflow*12)).toFixed(2);
          }
          combos.push({
            overdrive:od,
            injection: inj,
            monthsCount,
            breakEvenYears,
          });
        }
      }
    }

    combos= combos.filter(c=> c.breakEvenYears!=='-');
    if(combos.length===0){
      container.innerHTML=`<p class="text-danger">No feasible Overdrive+Injection combos found that yield positive net rent break-even under 37% ratio.</p>`;
      return;
    }
    combos.sort((a,b)=> parseFloat(a.breakEvenYears)- parseFloat(b.breakEvenYears));
    const topN= combos.slice(0, Math.min(3, combos.length));
    topN.forEach((cand, idx)=>{
      const cardDiv=document.createElement('div');
      cardDiv.className='col-md-6 col-lg-4';
      cardDiv.innerHTML=`
        <div class="card scenario-card border-success h-100">
          <div class="card-body">
            <h5 class="card-title text-success">
              <i class="bi bi-lightning"></i> OD ${cand.overdrive}% + Inj ${cand.injection}%
            </h5>
            <p><strong>Approx Term:</strong> ${cand.monthsCount} months (~${(cand.monthsCount/12).toFixed(1)} yrs)</p>
            <p><strong>Break-Even:</strong> ${cand.breakEvenYears} yrs</p>
            <p class="text-muted small">Satisfies 37% ratio constraint</p>
          </div>
        </div>
      `;
      container.appendChild(cardDiv);
    });
  }

  /****************************
   * onLoad
   ****************************/
  window.addEventListener('load', ()=>{
    initCharts();
    const updateAll=()=> updateSingleScenario();

    const inputIds=[
      "housingValue","manualDownPayment","notaryFeesRate","insuranceRate",
      "monthlyIncome","creditYears","interestRateSingle","propertyTax",
      "monthlyRent","monthlyExpenses","occupancyRate","paymentOverdrive",
      "incomeInjection"
    ];
    inputIds.forEach(id=>{
      const elem=document.getElementById(id);
      if(elem) elem.addEventListener("input", updateAll);
    });

    updateAll();
  });
</script>
</body>
</html>
